from pyrogram import Client, filters
from pyrogram.types import Message
import aiohttp
from SonaliChat import app
from config import BOT_USERNAME as B, OWNER_USERNAME as O

@app.on_message(filters.command("genimg"))
async def generate_image(client: Client, message: Message):
    chat_id = message.chat.id
    prompt = message.text.split(" ", 1)[1] if len(message.command) > 1 else None

    if not prompt:
        await message.reply_text("âŒ Please provide a prompt.\n\nğŸ§  Usage: `/genimg <your prompt>`", parse_mode="markdown")
        return

    fetching = await message.reply_text("â³ *Êœá´ÊŸá´… á´É´ !! ğ–¢Ê€á´€Ò“á´›ÉªÉ´É¢ Êá´á´œÊ€ á´€Ê€á´›Éªsá´›Éªá´„ á´á´€sá´›á´‡Ê€á´˜Éªá´‡á´„á´‡...* ğŸ¨", parse_mode="markdown")

    try:
        url = f"https://death-image.ashlynn.workers.dev/?prompt={prompt}&image=1&dimensions=square&safety=true"

        async with aiohttp.ClientSession() as session:
            async with session.get(url) as resp:
                if resp.status != 200:
                    raise Exception("Failed to fetch image from API.")
                data = await resp.json()

        images = data.get("images", [])
        if not images:
            await fetching.edit("âŒ No images returned from the API.")
            return

        caption = f"""
âœ¨ **ğ–¡á´‡Êœá´ÊŸá´… ğ–¸á´á´œÊ€ ğ–£Ê€á´‡á´€á´á´‡á´… ğ– Ê€á´›á´¡á´Ê€á´‹ !!** âœ¨  

ğŸŒŸ **ğ–¯Ê€á´á´á´˜á´›**: {prompt}  
ğŸ–Œï¸ **ğ–¢Ê€á´‡á´€á´›á´‡á´… Ê™Ê**: *á´›Êœá´‡ á´á´€É¢Éªá´„ á´Ò“ á´˜á´œÊ€á´ Éª á´€Éª*  
ğŸ”® **ğ–¯á´á´¡á´‡Ê€á´‡á´… Ê™Ê**: @{B}  
â¤ï¸ **Ï»á´€á´…á´‡ Ê™Ê**: @{O}  
"""

        for img_url in images:
            await client.send_photo(chat_id, img_url, caption=caption, parse_mode="markdown")

        await fetching.delete()

    except Exception as e:
        print(f"Error generating image: {e}")
        await fetching.edit("âŒ An error occurred while generating the image.")
